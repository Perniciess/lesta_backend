КОд рабочий, но нужно проверить

+ привести его в порядок и подогнать под паттерн MVC, а то там по факту каша, особенно в контроллере